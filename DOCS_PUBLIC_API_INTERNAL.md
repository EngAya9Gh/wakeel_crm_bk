# ุชูุซูู ุฏุงุฎูู: Public API ููููุงุฐุฌ ุงูุฎุงุฑุฌูุฉ

> **ูููุฑูู ุงูุชููู ููุท**  
> **ุชุงุฑูุฎ ุงูุฅูุดุงุก:** 2026-01-24

---

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅูุดุงุก **Public API Endpoint** ูุงุณุชูุจุงู ุจูุงูุงุช ุงูุนููุงุก ูู ููุงุฐุฌ ุงููููุน ุงูุฅููุชุฑููู ุงูุฎุงุฑุฌู ุจุดูู ุขูู.

### ุงููุฏู
- ุชุณุฌูู ุงูุนููุงุก ุงูุฌุฏุฏ (Leads) ุชููุงุฆูุงู ูู ููุงุฐุฌ ุงููููุน
- ุนุฏู ุงูุญุงุฌุฉ ูุฅุฏุฎุงู ุงูุจูุงูุงุช ูุฏููุงู
- ุชุชุจุน ูุตุฏุฑ ูู ุนููู (Contact Form vs Landing Page)

---

## ๐๏ธ ุงูุจููุฉ ุงูุชูููุฉ

### ุงููููุงุช ุงููููุดุฃุฉ

```
app/
โโโ Http/
โ   โโโ Controllers/
โ   โ   โโโ Api/
โ   โ       โโโ Public/
โ   โ           โโโ LeadController.php          # Controller ููู Public API
โ   โโโ Requests/
โ   โ   โโโ Api/
โ   โ       โโโ Public/
โ   โ           โโโ StoreLeadRequest.php        # Validation ููุจูุงูุงุช ุงููุงุฑุฏุฉ
โ   โโโ Middleware/
โ       โโโ ValidateApiKey.php                  # Middleware ููุชุญูู ูู API Key

database/
โโโ seeders/
    โโโ WebsiteFormsSourceSeeder.php            # Seeder ูุฅุถุงูุฉ ุงููุตุงุฏุฑ

config/
โโโ services.php                                # ุฅุถุงูุฉ API Keys Config

routes/
โโโ api.php                                     # ุฅุถุงูุฉ Public Routes

bootstrap/
โโโ app.php                                     # ุชุณุฌูู Middleware

DOCS_PUBLIC_API_INTEGRATION.md                 # ุชูุซูู ูููุจุฑูุฌ ุงูุฎุงุฑุฌู
```

---

## ๐ ุขููุฉ ุงููุตุงุฏูุฉ

### API Key Authentication

- **ูุง ูุชุทูุจ:** ุชุณุฌูู ุฏุฎูู ูุณุชุฎุฏู (Sanctum)
- **ูุชุทูุจ:** API Key ุตุงูุญ

### ููููุฉ ุฅุถุงูุฉ API Keys

1. **ูู ููู `.env`:**
```bash
PUBLIC_API_KEYS=key1_abc123xyz,key2_def456uvw,key3_ghi789rst
```

2. **ุชูููุฏ API Key ุขูู:**
```bash
php artisan tinker
>>> Str::random(40)
=> "xJ8kL2mN9pQ4rS6tU7vW8xY0zA1bC3dE5fG7hI9j"
```

3. **ุฅุถุงูุฉ ุงูู Key ูููููุน ุงูุฎุงุฑุฌู:**
   - ุฃุฑุณู ุงูู Key ุจุดูู ุขูู ูููุจุฑูุฌ
   - ูุฌุจ ุญูุธู ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ (Environment Variables) ูุฏููู
   - **ูุง ูุฌุจ** ูุถุนู ูู Frontend Code

---

## ๐ฃ๏ธ ุงูู Routes

### Public Route (ุจุฏูู ูุตุงุฏูุฉ ูุณุชุฎุฏู)

```php
// routes/api.php

Route::prefix('public/v1')->middleware('api.key')->group(function () {
    Route::post('leads', [LeadController::class, 'store']);
});
```

### ุงูุฑุงุจุท ุงููุงูู
```
POST https://your-domain.com/api/public/v1/leads
```

---

## ๐ฅ ุขููุฉ ุงูุนูู (Flow)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  1. ุงููุณุชุฎุฏู ูููุฃ ุงููููุฐุฌ ูู ุงููููุน ุงูุฎุงุฑุฌู                  โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  2. ุงููููุน ูุฑุณู POST Request ูุน API Key                     โ
โ     Headers: X-API-Key: abc123...                           โ
โ     Body: { name, phone, email, source, ... }               โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  3. Middleware: ValidateApiKey                              โ
โ     โ ูุชุญูู ูู ูุฌูุฏ API Key                                โ
โ     โ ูุชุญูู ูู ุตุญุฉ ุงูู Key                                  โ
โ     โ ุฅุฐุง ูุดู: ูุฑุฌุน 401/403                                โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  4. Request Validation: StoreLeadRequest                    โ
โ     โ ูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช                                โ
โ     โ ููุณู ุฑูู ุงููุงุชู (+966...)                            โ
โ     โ ุฅุฐุง ูุดู: ูุฑุฌุน 422 ูุน ุงูุฃุฎุทุงุก                        โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  5. Controller: LeadController@store                        โ
โ     โข ูุญุถูุฑ ุจูุงูุงุช ุงูุนููู                                   โ
โ     โข ูุญุฏุฏ ุงูู Status ุงูุงูุชุฑุงุถู (ุฌุฏูุฏ)                      โ
โ     โข ูุญุฏุฏ ุงูู Source ุจูุงุกู ุนูู ุงููููุฐุฌ                     โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  6. Service: ClientService@createClient                     โ
โ     โข ููุดุฆ ุณุฌู ุงูุนููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช                     โ
โ     โข ูุณุฌู Timeline Event                                   โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  7. ุฅุถุงูุฉ Comment (ุฅุฐุง ูุฌุฏ message/subject)                โ
โ     โข ููุดุฆ ุชุนููู ุจูุญุชูู ุงูุฑุณุงูุฉ                             โ
โ     โข User ID = 1 (System User)                             โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  8. Response: 201 Created                                   โ
โ     { success: true, data: { lead_id, name, phone } }       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ ุชูุงุตูู ุงูู Controller

### LeadController::store()

```php
public function store(StoreLeadRequest $request): JsonResponse
{
    // 1. ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช ุงูููุชุญูู ูููุง
    $data = $request->validated();
    
    // 2. ุชุญุถูุฑ ุจูุงูุงุช ุงูุนููู
    $clientData = [
        'name' => $data['name'],
        'phone' => $data['phone'],
        'email' => $data['email'] ?? null,
        'status_id' => $this->getDefaultStatusId(),
        'source_id' => $this->getSourceIdByName($data['source']),
        'priority' => 'medium',
        'lead_rating' => 'warm',
        'first_contact_at' => now(),
    ];
    
    // 3. ุฅูุดุงุก ุงูุนููู
    $client = $this->clientService->createClient($clientData);
    
    // 4. ุฅุถุงูุฉ ุงูุชุนููู (ุฅุฐุง ูุฌุฏ)
    if (!empty($data['message']) || !empty($data['subject'])) {
        $this->addInitialComment($client->id, $data);
    }
    
    // 5. ุฅุฑุฌุงุน ุงูุงุณุชุฌุงุจุฉ
    return $this->createdResponse([...], 'ุชู ุชุณุฌูู ุงูุนููู ุจูุฌุงุญ');
}
```

---

## ๐ ุงูุจูุงูุงุช ุงูููุณุฌูุฉ

### ูู ุฌุฏูู `clients`

| ุงูุญูู | ุงููููุฉ | ุงููุตุฏุฑ |
|------|--------|--------|
| `name` | ูู ุงููููุฐุฌ | ูุจุงุดุฑ |
| `phone` | ูู ุงููููุฐุฌ (ููุณู) | ูุจุงุดุฑ |
| `email` | ูู ุงููููุฐุฌ | ูุจุงุดุฑ |
| `company` | ูู ุงููููุฐุฌ | ูุจุงุดุฑ |
| `address` | ูู ุงููููุฐุฌ | ูุจุงุดุฑ |
| `status_id` | ุงูุญุงูุฉ ุงูุงูุชุฑุงุถูุฉ | `ClientStatus::where('is_default', true)` |
| `source_id` | ุญุณุจ ุงููููุฐุฌ | `Source::where('name', 'ูููุฐุฌ ุงุชุตู ุจูุง')` |
| `priority` | `medium` | ุงูุชุฑุงุถู |
| `lead_rating` | `warm` | ุงูุชุฑุงุถู |
| `source_status` | `valid` | ุงูุชุฑุงุถู |
| `first_contact_at` | ุงูุขู | `now()` |
| `assigned_to` | `null` | ูุชู ุงูุฅุณูุงุฏ ูุงุญูุงู |

### ูู ุฌุฏูู `comments` (ุฅุฐุง ูุฌุฏ message/subject)

| ุงูุญูู | ุงููููุฉ |
|------|--------|
| `client_id` | ID ุงูุนููู ุงููููุดุฃ |
| `user_id` | `1` (System User) |
| `content` | `"ุงูููุถูุน: ... \n\n ุงูุฑุณุงูุฉ: ..."` |
| `outcome` | `neutral` |

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### 1. ุชุดุบูู ุงูู Seeder

```bash
php artisan db:seed --class=WebsiteFormsSourceSeeder
```

### 2. ุฅุถุงูุฉ API Key ููุงุฎุชุจุงุฑ

ูู `.env`:
```bash
PUBLIC_API_KEYS=test_key_12345
```

### 3. ุงุฎุชุจุงุฑ ุงูู Endpoint

```bash
curl -X POST http://localhost:8000/api/public/v1/leads \
  -H "Content-Type: application/json" \
  -H "X-API-Key: test_key_12345" \
  -d '{
    "name": "ุนููู ุชุฌุฑูุจู",
    "phone": "0501234567",
    "email": "test@example.com",
    "subject": "ุงุฎุชุจุงุฑ ุงููุธุงู",
    "message": "ูุฐุง ุงุฎุชุจุงุฑ ููุชุฃูุฏ ูู ุนูู API",
    "source": "contact_form"
  }'
```

### ุงููุชูุฌุฉ ุงููุชููุนุฉ

```json
{
  "success": true,
  "message": "ุชู ุชุณุฌูู ุงูุนููู ุจูุฌุงุญ ูู ุงููุธุงู",
  "data": {
    "lead_id": 1,
    "name": "ุนููู ุชุฌุฑูุจู",
    "phone": "+966501234567",
    "status": "registered"
  }
}
```

---

## ๐ ุงูุฃูุงู

### โ ูุง ุชู ุชุทุจููู

1. **API Key Authentication:** ููุน ุงููุตูู ุบูุฑ ุงููุตุฑุญ
2. **Validation:** ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
3. **Phone Normalization:** ุชูุญูุฏ ุตูุบุฉ ุงูุฃุฑูุงู
4. **Unique Phone:** ููุน ุงูุชุณุฌูู ุงูููุฑุฑ
5. **Rate Limiting:** (ูููู ุฅุถุงูุชู ูุงุญูุงู)

### โ๏ธ ููุงุญุธุงุช ุฃูููุฉ

1. **ูุง ุชุดุงุฑู API Keys ุนููุงู**
2. **ุงุณุชุฎุฏู HTTPS ูู Production**
3. **ุฑุงูุจ ุงูุทูุจุงุช ุงููุดุจููุฉ**
4. **ูู ุจุชุฏููุฑ ุงูู Keys ุฏูุฑูุงู**

---

## ๐ ุงููุฑุงูุจุฉ ูุงูุชุชุจุน

### ูุง ูุฌุจ ูุฑุงูุจุชู

1. **ุนุฏุฏ ุงูู Leads ุงูููุณุฌูุฉ ููููุงู**
   ```sql
   SELECT COUNT(*) FROM clients 
   WHERE DATE(created_at) = CURDATE() 
   AND source_id IN (SELECT id FROM sources WHERE name LIKE '%ูููุฐุฌ%');
   ```

2. **ูุนุฏู ุงููุดู (Failed Requests)**
   - ุฑุงุฌุน ุงูู Logs: `storage/logs/laravel.log`

3. **ุงูุฃุฑูุงู ุงูููุฑุฑุฉ**
   ```sql
   SELECT phone, COUNT(*) as attempts 
   FROM clients 
   WHERE created_at > DATE_SUB(NOW(), INTERVAL 1 DAY)
   GROUP BY phone 
   HAVING attempts > 1;
   ```

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉ

### ุงููุดููุฉ: "API Key ูุทููุจ"

**ุงูุณุจุจ:** ุงูู Middleware ูุง ูุฌุฏ ุงูู Key  
**ุงูุญู:**
1. ุชุฃูุฏ ูู ุชุณุฌูู ุงูู Middleware ูู `bootstrap/app.php`
2. ุชุฃูุฏ ูู ุฅุฑุณุงู ุงูู Header: `X-API-Key`

### ุงููุดููุฉ: "ุฑูู ุงููุงุชู ูุณุฌู ูุณุจูุงู"

**ุงูุณุจุจ:** ุงูุฑูู ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช  
**ุงูุญู:**
- ูุฐุง ุณููู ุตุญูุญ (ููุน ุงูุชูุฑุงุฑ)
- ูููู ุชุนุฏูู ุงูู Logic ูุชุญุฏูุซ ุงูุจูุงูุงุช ุจุฏูุงู ูู ุงูุฑูุถ

### ุงููุดููุฉ: "Source ID is null"

**ุงูุณุจุจ:** ุงููุตุฏุฑ ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช  
**ุงูุญู:**
```bash
php artisan db:seed --class=WebsiteFormsSourceSeeder
```

---

## ๐ ุงูุชุญุฏูุซุงุช ุงููุณุชูุจููุฉ

### ููุฒุงุช ููุชุฑุญุฉ

1. **Webhook Notifications:**
   - ุฅุฑุณุงู ุฅุดุนุงุฑ ููุฑู ุนูุฏ ุชุณุฌูู Lead ุฌุฏูุฏ
   - ุฅูู Slack ุฃู WhatsApp

2. **Auto-Assignment:**
   - ุฅุณูุงุฏ ุงูุนููู ุชููุงุฆูุงู ูููุธู ุญุณุจ ุงูููุทูุฉ/ุงูุญูู

3. **Duplicate Detection:**
   - ุงูุชุดุงู ุงูุนููุงุก ุงูููุฑุฑูู ุจุฐูุงุก (ุงุณู ูุดุงุจู + ุฑูู ูุฎุชูู)

4. **Lead Scoring:**
   - ุชูููู ุฌูุฏุฉ ุงูู Lead ุจูุงุกู ุนูู ุงูุจูุงูุงุช ุงูููุฏุฎูุฉ

---

## ๐ ุฌูุงุช ุงูุงุชุตุงู

- **ุงููุทูุฑ ุงูุฑุฆูุณู:** [ุงุณูู]
- **ูุฏูุฑ ุงููุดุฑูุน:** [ุงูุงุณู]
- **ุงูุฏุนู ุงูููู:** support@crm-wakeel.com

---

**ุขุฎุฑ ุชุญุฏูุซ:** 2026-01-24  
**ุงูุฅุตุฏุงุฑ:** 1.0
